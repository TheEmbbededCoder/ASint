{% extends "layout.html" %}
{% block title %}QR Code Reader{% endblock %}
{% block head %}
  {{ super() }}
    <style type="text/css">
    .important { color: #336699; }
    .button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 5px 10px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      margin: 2px 2px;
      cursor: pointer;
    }
    </style>
    <script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js" ></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
{% endblock %}
{% block content %}
    <h1>QR Code Reader</h1>
    <div id="form">
        <div id="button">
            <button class="button">Init Scanner</button>
        </div>
        <br>
        <video id="preview"></video>
        <div id="infoDisp"></div>
    </div>

    <script>
        let scanner = new Instascan.Scanner(
            {
                video: document.getElementById('preview')
            }
        );
        scanner.addListener('scan', function(content) {
            var arrayLink = content.split('/');
            var i;
            content = arrayLink[0];
            for(i = 1; i < arrayLink.length; i++){
                content = content + '/';
                content = content + arrayLink[i];
                if(i == 2){
                    content = content + '/';
                    content = content + "API";
                }
            }
            
            $.getJSON(content, function(data) {
                $("#preview").hide();
                scanner.stop();
                console.log(data);
                
                var arr = content.split('/');
                console.log(arr);
                $("#infoDisp").empty();
                if(arr[arr.length-1]=="secretariat"){
                    var i = 1;
                    
                    $.each( data.secretariat, function( key, val ) { 
                        var items = [];
                        items.push("<h3>Secretariat " + i.toString()+"</h3>");
                        i = i+1;
                        $.each( val, function( key, val ) {
                            items.push("<li id='" + key + "'>" +key + ":"+ val + "</li>" );
                            
                        });
                        $( "<ul/>", {
                            "class": "secretariat-list",
                            html: items.join( "" )
                        }).appendTo( "#infoDisp" );
                    }); 
                } else if(arr[arr.length-2]=="rooms"){
                    //parse cenas
                }
                
                
                
            });
        });
        $( "#button" ).click(function() {
            $( "#preview" ).show( "slow", function() {
                // Animation complete.
            });
            Instascan.Camera.getCameras().then(cameras => 
            {
                if(cameras.length > 0){
                    scanner.start(cameras[0]);
                } else {
                    console.error("Please enable Camera!");
                }
            });
        });
        
    </script>
{% endblock %}